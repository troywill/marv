#!/usr/bin/env perl
use warnings;
use strict;
my $verbose = 1;

chomp(my $tty = `tty`);
exit unless ( $tty eq "/dev/tty1" );
open my $LOG, '>>', "$ENV{'HOME'}/log/marv.log" or warn "Unable to open log file: $!";
print $LOG time, ' start at ', `date`, "\n";
close $LOG;

&rails;
&detect_wireless;
&connect_to_wireless;
&marv_menu;
exit;

sub connect_to_wireless {
    # Connect to Claremont office if router is detected
    # Cell 01 - Address: 00:13:10:8D:40:1E
    my $claremont = '00:13:10:8D:40:1E';
    my $stanford = '00:22:6B:A2:59:EF';
    system("sudo ip link set wlan0 up");
    # check for claremont and stanford
    open(SCANNING, "sudo iwlist wlan0 scanning 2>&1 |")
	|| die "can't fork: $!";
    while (<SCANNING>) {
	if ( /$claremont/ ) {
	    system("/etc/rc.d/asus-networking-perl");
	    last;
	} elsif ( /$stanford/ ) {
	    system("marv-wireless");
	    last;
	}
    }
    close SCANNING || die "bad scan: $! $?";
}

sub marv_menu {
    print `clear`;
    exec '/usr/local/bin/marv-menu';
}

sub detect_wireless {
    system("sudo ip link set wlan0 up");
    system("sudo pass1.pl");
}

sub rails {
    chdir "/home/marv/rails/marv";
    system("sh server.sh 2>/dev/null&");
    print "Starting weight loss application ...\n";
}

# system("startx");

sub wireless {
    my $command = "wpa_supplicant -Dwext -iwlan0 -c/etc/wpa_supplicant.conf";
    print "=> sudo $command\n";
    system("sudo $command > /dev/null &");
    sleep 1;
    $command = "dhcpcd wlan0";
    print "=> sudo $command\n";
    system("sudo $command 2> /dev/null &");
}
